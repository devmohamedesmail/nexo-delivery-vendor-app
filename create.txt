import useFetch from '@/hooks/useFetch'
import React, { useState, useContext } from 'react'
import { Text, View, ScrollView, Platform, TouchableOpacity } from 'react-native'
import { useTranslation } from 'react-i18next'
import { useRouter } from 'expo-router'
import { useFormik } from 'formik'
import * as Yup from 'yup'
import axios from 'axios'
import { config } from '@/constants/config'
import { AuthContext } from '@/context/auth-provider'
import Select from '@/components/ui/Select'
import Loading from '@/components/ui/Loading'
import Input from '@/components/ui/Input'
import CustomButton from '@/components/ui/button'
import CustomImagePicker from '@/components/ui/customimagepicker'
import { Toast } from 'toastify-react-native'
import DateTimePicker from '@react-native-community/datetimepicker'
import { Ionicons } from '@expo/vector-icons'
import Layout from '@/components/store/Layout'


interface StoreType {
  id: number
  name_en: string
  name_ar: string
  description: string | null
}

interface Place {
  id: number
  name: string
  address: string
  latitude: string
  longitude: string
  createdAt: string
  updatedAt: string
  storeTypes: StoreType[]
}

interface StoreFormValues {
  place_id: string
  store_type_id: string
  name: string
  logo: string
  phone: string
  start_time: string
  end_time: string
  
}

export default function Create() {
  const { t, i18n } = useTranslation()
  const router = useRouter()
  const { auth } = useContext(AuthContext)
  const { data: placesData, loading: loadingPlaces, error: errorPlaces } = useFetch('/places')
  const { data: storeTypeData, loading: loadingStoreType } = useFetch('/store-types')
  const [isSubmitting, setIsSubmitting] = useState<boolean>(false)
  const isArabic = i18n.language === 'ar'
 console.log(storeTypeData?.data)
  // Time picker states
  const [showStartTimePicker, setShowStartTimePicker] = useState(false)
  const [showEndTimePicker, setShowEndTimePicker] = useState(false)
  const [startTimeDate, setStartTimeDate] = useState(new Date())
  const [endTimeDate, setEndTimeDate] = useState(new Date())

  // Validation schema
  const validationSchema = Yup.object().shape({
    place_id: Yup.string().required(t('store.placeRequired')),
    store_type_id: Yup.string().required(t('store.storeTypeRequired')),
    name: Yup.string().required(t('store.nameRequired')),
    phone: Yup.string().required(t('store.phoneRequired') ),
    start_time: Yup.string().required(t('store.startTimeRequired')),
   
  })

  // Formik setup
  const formik = useFormik<StoreFormValues>({
    initialValues: {
      place_id: '',
      store_type_id: '',
      name: '',
      logo: '',
      phone: '',
      start_time: '',
      end_time: '',
  
    },
    validationSchema,
    onSubmit: async (values) => {
      setIsSubmitting(true)

      try {
        const formData = new FormData()
        formData.append('user_id', auth?.user?.id)
        formData.append('store_type_id', values.store_type_id)
        formData.append('name', values.name)
        formData.append('phone', values.phone)
        formData.append('start_time', values.start_time)
        formData.append('end_time', values.end_time)
       

        // Add images if selected
        if (values.logo) {
          const logoFile = {
            uri: values.logo,
            type: 'image/jpeg',
            name: 'logo.jpg',
          } as any
          formData.append('logo', logoFile)
        }

      

        const {data} = await axios.post(`${config.URL}/stores/create`, formData, {
          headers: {
            'Content-Type': 'multipart/form-data',
            'Authorization': `Bearer ${auth.token}`
          }
        })

        if (data?.success) {
          Toast.show({
            type: 'success',
            text1: t('store.storeCreatedSuccess'),
            position: 'bottom',
            visibilityTime: 1000,
          })
          formik.resetForm()
          setTimeout(()=>{router.push('/')}, 1000)
          
        } else {
          console.log(data)
          Toast.show({
            type: 'error',
            text1: t('store.storeCreationFailed'),
            position: 'bottom',
            visibilityTime: 2000,
          })
        }

      } catch (error: any) {
        console.log('Store creation error:', error.response || error.message || error)
        Toast.show({
          type: 'error',
          text1:t('store.storeCreationFailed'),
          position: 'bottom',
          visibilityTime: 2000,
        })
      } finally {
        setIsSubmitting(false)
      }
    },
  })

  // Get the selected place object - Fix: Access data property correctly
  const selectedPlace = placesData?.data?.find((place: Place) => place.id.toString() === formik.values.place_id)

  // Get store types for the selected place
  const availableStoreTypes = selectedPlace?.storeTypes || []

  // Format places for dropdown - Fix: Access data property correctly
  const placeOptions = placesData?.data?.map((place: Place) => ({
    label: place.name,
    value: place.id.toString()
  })) || []

  // Format store types for dropdown
  const storeTypeOptions = availableStoreTypes.map((type: StoreType) => ({
    label: i18n.language === 'ar' ? type.name_ar : type.name_en,
    value: type.id.toString()
  }))

  const handlePlaceSelect = (value: string) => {
    formik.setFieldValue('place_id', value)
    // Reset store type when place changes
    // formik.setFieldValue('store_type_id', '')
  }

  // Time picker handlers
  const handleStartTimeChange = (event: any, selectedDate?: Date) => {
    setShowStartTimePicker(Platform.OS === 'ios')
    if (selectedDate) {
      setStartTimeDate(selectedDate)
      const hours = selectedDate.getHours().toString().padStart(2, '0')
      const minutes = selectedDate.getMinutes().toString().padStart(2, '0')
      formik.setFieldValue('start_time', `${hours}:${minutes}`)
    }
  }

  const handleEndTimeChange = (event: any, selectedDate?: Date) => {
    setShowEndTimePicker(Platform.OS === 'ios')
    if (selectedDate) {
      setEndTimeDate(selectedDate)
      const hours = selectedDate.getHours().toString().padStart(2, '0')
      const minutes = selectedDate.getMinutes().toString().padStart(2, '0')
      formik.setFieldValue('end_time', `${hours}:${minutes}`)
    }
  }

  if (loadingPlaces) {
    return <Loading />
  }

  return (
   <Layout>
      <ScrollView className="flex-1 px-6 pt-4" showsVerticalScrollIndicator={false}>
          {/* Subtitle */}
          <Text className={`text-gray-600 text-center mb-6 `} >
            {t('store.createStoreSubtitle') }
          </Text>

          {/* Form Card */}
          <View className="bg-white rounded-2xl shadow-sm p-6 mb-6">
            {/* Section 1: Location & Type */}
            <View className="mb-6">
              <View className={`flex-row items-center mb-4 ${isArabic ? 'flex-row-reverse' : 'text-left'}`}>
                <Ionicons name="location-outline" size={24} color="#fd4a12" />
                <Text className="text-lg font-semibold text-gray-800 ml-2" >
                  {t('store.locationAndType')}
                </Text>
              </View>
              <View className="h-1 w-20 bg-primary rounded mb-4" />

              {/* Place Selection */}
              <Select
                label={t('store.selectPlace') || 'Select Place'}
                placeholder={t('store.choosePlacePlaceholder') || 'Choose a place'}
                value={formik.values.place_id}
                onSelect={handlePlaceSelect}
                options={placeOptions}
                error={formik.touched.place_id && formik.errors.place_id ? formik.errors.place_id : undefined}
              />

              {/* Store Type Selection - Only show when place is selected */}
              {formik.values.place_id && (
                <Select
                  label={t('store.selectStoreType') || 'Select Store Type'}
                  placeholder={t('store.chooseStoreTypePlaceholder') || 'Choose a store type'}
                  value={formik.values.store_type_id}
                  onSelect={(value: string) => formik.setFieldValue('store_type_id', value)}
                  options={storeTypeData?.data}
                  disabled={availableStoreTypes.length === 0}
                  error={formik.touched.store_type_id && formik.errors.store_type_id ? formik.errors.store_type_id : undefined}
                />
              )}

              {/* Show message if no store types available */}
              {formik.values.place_id && availableStoreTypes.length === 0 && (
                <View className="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mt-4">
                  <Text className="text-yellow-800 text-center" style={{ fontFamily: 'Cairo_400Regular' }}>
                    {t('store.noStoreTypesAvailable') || 'No store types available for this place'}
                  </Text>
                </View>
              )}
            </View>

            {/* Show form fields only when store type is selected */}
            {formik.values.store_type_id && (
              <>
                {/* Section 2: Store Information */}
                <View className="mb-6">
                  <View className={`flex-row items-center mb-4 ${isArabic ? 'flex-row-reverse' : 'text-left'}`}>
                    <Ionicons name="storefront-outline" size={24} color="#fd4a12" />
                    <Text className="text-lg font-semibold text-gray-800 ml-2" >
                      {t('store.storeInformation') || 'Store Information'}
                    </Text>
                  </View>
                  <View className="h-1 w-20 bg-primary rounded mb-4" />

                  {/* Store Name */}
                  <Input
                    label={t('store.storeName') || 'Store Name *'}
                    placeholder={t('store.enterStoreName') || 'Enter store name'}
                    value={formik.values.name}
                    onChangeText={formik.handleChange('name')}
                    keyboardType="default"
                    error={formik.touched.name && formik.errors.name ? formik.errors.name : undefined}
                  />

                  {/* Address */}
                  {/* <Input
                    label={t('store.storeAddress') || 'Address *'}
                    placeholder={t('store.enterAddress') || 'Enter address'}
                    value={formik.values.address}
                    onChangeText={formik.handleChange('address')}
                    keyboardType="default"
                    error={formik.touched.address && formik.errors.address ? formik.errors.address : undefined}
                  /> */}

                  {/* Phone */}
                  <Input
                    label={t('store.storePhone') || 'Phone *'}
                    placeholder={t('store.enterPhone') || 'Enter phone number'}
                    value={formik.values.phone}
                    onChangeText={formik.handleChange('phone')}
                    keyboardType="phone-pad"
                    error={formik.touched.phone && formik.errors.phone ? formik.errors.phone : undefined}
                  />
                </View>

                {/* Section 3: Store Images */}
                <View className="mb-6">
                  <View className={`flex-row items-center mb-4 ${isArabic ? 'flex-row-reverse' : 'text-left'}`}>
                    <Ionicons name="images-outline" size={24} color="#fd4a12" />
                    <Text className="text-lg font-semibold text-gray-800 ml-2">
                      {t('store.storeImages')}
                    </Text>
                  </View>
                  <View className="h-1 w-20 bg-primary rounded mb-4" />

                  {/* Logo Image */}
                  <CustomImagePicker
                    label={t('store.storeLogo') || 'Store Logo'}
                    placeholder={t('store.selectLogo') || 'Tap to select logo'}
                    value={formik.values.logo}
                    onImageSelect={(uri) => formik.setFieldValue('logo', uri)}
                    aspect={[1, 1]}
                    allowsEditing={true}
                  />

                  {/* Banner Image */}
                  {/* <CustomImagePicker
                    label={t('store.storeBanner') || 'Store Banner'}
                    placeholder={t('store.selectBanner') || 'Tap to select banner'}
                    value={formik.values.banner}
                    onImageSelect={(uri) => formik.setFieldValue('banner', uri)}
                    aspect={[16, 9]}
                    allowsEditing={true}
                  /> */}
                </View>

                {/* Section 4: Operating Hours */}
                <View className="mb-6">
                  <View className={`flex-row items-center mb-4 ${isArabic ? 'flex-row-reverse' : 'text-left'}`}>
                    <Ionicons name="time-outline" size={24} color="#fd4a12" />
                    <Text className="text-lg font-semibold text-gray-800 ml-2" >
                      {t('store.operatingHours')}
                    </Text>
                  </View>
                  <View className="h-1 w-20 bg-primary rounded mb-4" />

                  {/* Start Time */}
                  <View className="mb-4">
                    <Text className="text-gray-700 font-medium mb-2" style={{ fontFamily: 'Cairo_500Medium' }}>
                      {t('store.startTime')}
                    </Text>
                    <TouchableOpacity
                      onPress={() => setShowStartTimePicker(true)}
                      className="bg-gray-50 border border-gray-200 rounded-xl p-4 flex-row items-center justify-between"
                    >
                      <Text className={formik.values.start_time ? 'text-gray-900' : 'text-gray-400'}>
                        {formik.values.start_time || t('store.selectStartTime')}
                      </Text>
                      <Ionicons name="time" size={20} color="#fd4a12" />
                    </TouchableOpacity>
                    {formik.touched.start_time && formik.errors.start_time && (
                      <Text className="text-red-500 text-sm mt-1">{formik.errors.start_time}</Text>
                    )}
                  </View>

                  {/* End Time */}
                  <View className="mb-4">
                    <Text className="text-gray-700 font-medium mb-2">
                      {t('store.endTime')}
                    </Text>
                    <TouchableOpacity
                      onPress={() => setShowEndTimePicker(true)}
                      className="bg-gray-50 border border-gray-200 rounded-xl p-4 flex-row items-center justify-between"
                    >
                      <Text className={formik.values.end_time ? 'text-gray-900' : 'text-gray-400'}>
                        {formik.values.end_time || t('store.selectEndTime') }
                      </Text>
                      <Ionicons name="time" size={20} color="#fd4a12" />
                    </TouchableOpacity>
                    {formik.touched.end_time && formik.errors.end_time && (
                      <Text className="text-red-500 text-sm mt-1">{formik.errors.end_time}</Text>
                    )}
                  </View>

                  {/* Time Pickers */}
                  {showStartTimePicker && (
                    <DateTimePicker
                      value={startTimeDate}
                      mode="time"
                      is24Hour={true}
                      display={Platform.OS === 'ios' ? 'spinner' : 'default'}
                      onChange={handleStartTimeChange}
                    />
                  )}

                  {showEndTimePicker && (
                    <DateTimePicker
                      value={endTimeDate}
                      mode="time"
                      is24Hour={true}
                      display={Platform.OS === 'ios' ? 'spinner' : 'default'}
                      onChange={handleEndTimeChange}
                    />
                  )}
                </View>

                

                {/* Submit Button */}
                <View className="mt-4">
                  {isSubmitting ? (
                    <Loading />
                  ) : (
                    <CustomButton
                      title={t('store.createStoreButton') || 'Create Store'}
                      onPress={formik.handleSubmit}
                    />
                  )}
                </View>
              </>
            )}
          </View>
        </ScrollView>
   </Layout>
  )
}